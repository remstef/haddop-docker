
networks:
  hadoopnet:
    driver: bridge

services:

  headnode:
    image: remstef/hadoop3-jobimtext
    hostname: headnode
    command: >-
      /bin/bash -c "
        ssh-server & 
        hdfs namenode & 
        sleep 2 && yarn resourcemanager &
        sleep 3 && mapred historyserver & 
        wait
      "
    volumes:
      # pass authorized_keys for quicker login
      - ~/.ssh/id_ed25519.pub:/opt/hadoop/.ssh/authorized_keys:ro
    networks:
      hadoopnet:
        aliases: 
          - namenode
          - resourcemanager
          - historyserver
    ports:
      - 9870:9870
      - 8088:8088
      - 2222:22
    env_file:
      - ./config-h3-sharedservices.env
    environment:
      ENSURE_NAMENODE_DIR: "/tmp/hadoop-hadoop/dfs/name"
      SSH_USER_PASSWORD: x

  node01: &workerref
    image: remstef/hadoop3
    hostname: node01
    command: >-
      /bin/bash -c "
        hdfs datanode & sleep 1 &&
        yarn nodemanager & wait
      "
    networks:
      - hadoopnet
    env_file:
      - ./config-h3-sharedservices.env
    environment:
      - SLEEP_SECONDS=5
      - WAITFOR=namenode:8020
